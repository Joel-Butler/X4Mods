<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Jbm_crew_dock_actions" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>
        <cue name="Jbm_on_owned_mlxml_dock" instantiate="true" >
			<!-- 
				Logic:
					1. Is the ship a player ship.
					2. Is it of size M, L or XL
					3. Does it have at least one crewmember outside of the captain (we'll assume for now the captain is going to be busy. 
					4. Do we have an active crew member up to mischief from this ship.
					5. TODO: Add global timeout - lets not make these too frequent.
			-->
			<conditions>
				<check_all>
					<event_object_docked group="global.$PlayerShipsGroup"/>
					<check_value value="event.object.trueowner" exact="faction.player" />
					<check_value value="$event.object.people.{entityrole.service}.count gt 0" />
				</check_all>
				<check_any>
					<check_value value="event.object.isclass.ship_l" />
					<check_value value="event.object.isclass.ship_m" />
					<check_value value="event.object.isclass.ship_xl" />
				</check_any>
			</conditions>
			<!-- So the important thing here is that to query a crew member, you must reference it via the parent object... in this case our ship. -->
			<actions>
				<set_value name="$sourceShip" exact="event.object" />
				<set_value name="$station" exact="event.object.dock.container" />
				<set_value name="$disorderlyCrewTemplate" exact="$sourceShip.people.{entityrole.service}.list.random" />
				<set_value name="$disorderlyCrewGender" exact="if $sourceShip.people.{$disorderlyCrewTemplate}.isfemale then 'female' else 'male'" />
				<debug_to_file name="'jbmcrew.txt'" text="'Docking Event for ship: ' + $sourceShip.name + ' size: ' + $sourceShip.class + ' Engineer workforce: ' + $sourceShip.people.{entityrole.service}.list.count" />
				<debug_to_file name="'jbmcrew.txt'" text="'Selected ' + $sourceShip.people.{$disorderlyCrewTemplate}.name + ' ' +  $sourceShip.people.{$disorderlyCrewTemplate}.race + ' ' +  $disorderlyCrewGender + ', engineer of ' + $sourceShip.name + ' for fun and profit :-)'" />	
				
				<find_room name="$prisonRoom" object="$station" roomtype="roomtype.prison" />
				
				<do_if value="$prisonRoom.isclass.room">
					<!-- Not clear what we'll do here yet apart from confirming we're good -->
				</do_if>
				<do_else>
					<set_value name="$CrewDetainPrisonMacro" exact="macro.room_gen_detentioncell_01_macro"/>
					<get_room_definition doors="$CrewDetainPrison_PrisonInteriorDoors" macro="$CrewDetainPrison_CorridorMacro" race="$station.owner.primaryrace" tags="tag.corridor" />
					<set_value name="$CrewDetainPrison_Door" exact="if $CrewDetainPrison_PrisonInteriorDoors.count ge 3 then $CrewDetainPrison_PrisonInteriorDoors.{3} else $CrewDetainPrison_PrisonInteriorDoors.{1}"/>
					<create_dynamic_interior object="$station" name="'CrewBrig'" 
						corridor="$CrewDetainPrison_CorridorMacro" 
						door="$CrewDetainPrison_Door" 
						room="macro.room_gen_detentioncell_01_macro" 
						roomname="$prisonRoom" 
						corridorname="$Corridor" 
						interiorname="$Interior" 
						persistent="true" roomtype="roomtype.prison"/>
				</do_else>
				<create_npc_from_template name="$crewNPC" object="$sourceShip" template="$disorderyCrewTemplate" owner="$station.faction" />
				<remove_npc_template object="$sourceShip" template="$disorderyCrewTemplate" />

				<find_npc_slot name="$NPCSlot" object="$prisonRoom" tags="tag.prisoner" multiple="false" excludefilled="true" />
				
				<signal_cue_instantly cue="md.NPC_Instantiation.NPC_Placement_Manager" param="['add_definition', $crewNPC, 
				table[
				$requestercue = $PlacementTable.$cue,
				$priority = $PlacementTable.$priority,
				$location = $prisonRoom,
				$slottags = [tag.prisoner],
				$debugchance = 100,
				$debugcaller = if $DebugChance == 100 then this else null]
				]"/>
				
				
				
				<!-- Todo: 
					1. Remove the crew member and store as a temporary object.
					2. Com the player with a call for help.
						a. Is the player nearby?
							aa. Yes - then instantiate a Brig room on this station, and assign our NPC as an actor to this room
							ab. No - then just run the call from a generic location for now. 
						Outcomes:
							1. Mission accept - create mission to visit brig and Staff actor to discuss paying fines.
								a. Mission
									aa. Converse with Station security/marine. Pay fines for staff release.
									ab. Outcome - significant increase in morale for single staff member. 
										aaa. Todo - Consider storing 'character' crew in table for more frequent use and recurring behavior. 
							2. Mission decline - remove staff member, log randomized morale increase/decrease for staff (could have been a liked or disliked crew member).

a					<create_npc_from_template object="" template="$disorderyCrewTemplate" owner="faction.alliance" setroomslot="true" required="true" placementobject=""></create_npc_from_template>
					2. Transfer the ownership of the crew member (temporarily) to the related faction and store them permanently.
					3. Raise a mission cue to go get them, or not as your avatar sees fit.
				-->
				
			</actions>
		</cue>
		<library name="Resources">
			<actions>
				<!-- crew we will reference and interact with later -->
				<set_value name="$crewRegister" exact="table[]" />
				
				<!-- a list of stations that are holding crew... we want to limit this for sanity and performance purposes. -->
				<set_value name="$brigRegister" exact="table[]" />
				
			</actions>

		</library>
  </cues>
</mdscript>